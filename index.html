<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registo Di√°rio de Giros - Transporte</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configura√ß√£o de Fonte Global */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos personalizados para o bot√£o de status */
        .status-ok { background-color: #10B981; color: white; }
        .status-nok { background-color: #EF4444; color: white; }
        .btn-primary { transition: all 0.2s ease-in-out; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .giro-line-input {
            margin-bottom: 0.75rem;
        }
        /* Fixa o header da tabela para melhor UX */
        #recordsTable thead th {
            position: sticky;
            top: 0;
            background-color: #F3F4F6;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-10 p-4 bg-white rounded-xl shadow-lg">
            <h1 class="text-3xl font-extrabold text-gray-800">Registo Di√°rio de Giros</h1>
            <p class="text-gray-500 mt-2">Gest√£o de Frotas e Servi√ßos de Transporte</p>
        </header>

        <!-- Navega√ß√£o entre Formul√°rio e Visualiza√ß√£o -->
        <div class="flex justify-center space-x-4 mb-8">
            <button id="showFormBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-200">
                Novo Registo / Editar
            </button>
            <button id="showViewBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-200">
                Visualizar Registos
            </button>
        </div>

        <!-- Mensagem de feedback (Modal customizado) -->
        <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                <p id="messageText" class="text-lg font-semibold text-gray-800 mb-4"></p>
                <div class="flex justify-end">
                    <button id="closeMessageBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                        OK
                    </button>
                </div>
            </div>
        </div>

        <!-- Conte√∫do Principal -->
        <div id="appContent">
            
            <!-- 1. FORMUL√ÅRIO (Padr√£o: Vis√≠vel) -->
            <div id="formContainer" class="bg-white p-6 sm:p-8 rounded-xl shadow-xl">
                <h2 id="formTitle" class="text-2xl font-semibold text-gray-700 mb-6">Novo Registo de Servi√ßo</h2>
                
                <form id="girosForm" class="space-y-6">

                    <!-- Campos de ID Ocultos -->
                    <input type="hidden" id="ID_Registo" value="">

                    <!-- Bloco de Informa√ß√µes Principais -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 border-b pb-6 mb-6">
                        <div class="col-span-1">
                            <label for="Data" class="block text-sm font-medium text-gray-700">Data <span class="text-red-500">*</span>:</label>
                            <input type="date" id="Data" name="Data" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div class="col-span-1">
                            <label for="Matricula" class="block text-sm font-medium text-gray-700">Matr√≠cula <span class="text-red-500">*</span>:</label>
                            <input type="text" id="Matricula" name="Matricula" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border uppercase">
                        </div>
                         <div class="col-span-1">
                            <label for="Motorista" class="block text-sm font-medium text-gray-700">Motorista <span class="text-red-500">*</span>:</label>
                            <input type="text" id="Motorista" name="Motorista" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div class="col-span-1">
                            <label for="Reboque" class="block text-sm font-medium text-gray-700">Reboque:</label>
                            <input type="text" id="Reboque" name="Reboque" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border uppercase">
                        </div>
                        <div class="col-span-1">
                            <label for="KM_Inicio_Dia" class="block text-sm font-medium text-gray-700">KM In√≠cio do Dia:</label>
                            <input type="number" id="KM_Inicio_Dia" name="KM_Inicio_Dia" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div class="col-span-1">
                            <label for="Hora_Inicio" class="block text-sm font-medium text-gray-700">Hora In√≠cio:</label>
                            <input type="time" id="Hora_Inicio" name="Hora_Inicio" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div class="col-span-1">
                            <label for="KM_Saida_Dia" class="block text-sm font-medium text-gray-700">KM Sa√≠da do Dia:</label>
                            <input type="number" id="KM_Saida_Dia" name="KM_Saida_Dia" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div class="col-span-1">
                            <label for="Hora_Fim" class="block text-sm font-medium text-gray-700">Hora Fim:</label>
                            <input type="time" id="Hora_Fim" name="Hora_Fim" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                    </div>

                    <!-- Bloco de Giros/Servi√ßos (Din√¢mico) -->
                    <div class="mb-6 border-b pb-6">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 flex justify-between items-center">
                            Detalhes dos Giros
                            <button type="button" id="addGiroBtn" class="bg-green-500 hover:bg-green-600 text-white text-sm py-1 px-3 rounded-lg shadow transition duration-200">
                                + Adicionar Giro
                            </button>
                        </h3>
                        <div id="girosContainer" class="space-y-4">
                            <!-- Linha de Giro 1 (Template) -->
                            <div id="giroLine-1" class="giro-line p-4 border border-gray-200 rounded-lg bg-gray-50 grid grid-cols-2 md:grid-cols-5 gap-4">
                                <!-- Conte√∫do preenchido pelo JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Bloco de Finaliza√ß√£o e Status -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 border-b pb-6 mb-6">
                        <div class="col-span-1">
                            <label for="Hora_Descarga" class="block text-sm font-medium text-gray-700">Hora Descarga:</label>
                            <input type="time" id="Hora_Descarga" name="Hora_Descarga" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div class="col-span-1">
                            <label for="KM_Descarga" class="block text-sm font-medium text-gray-700">KM Descarga:</label>
                            <input type="number" id="KM_Descarga" name="KM_Descarga" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div class="col-span-1">
                            <label for="Servico_Status" class="block text-sm font-medium text-gray-700">Servi√ßo OK / NOK:</label>
                            <select id="Servico_Status" name="Servico_Status" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-white">
                                <option value="">Selecione...</option>
                                <option value="OK">OK (Pisco)</option>
                                <option value="NOK">NOK</option>
                            </select>
                        </div>
                    </div>

                    <!-- Bloco de Abastecimentos -->
                    <div class="border-b pb-6 mb-6">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">a. Abastecimentos</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="Abastecimento_Data" class="block text-sm font-medium text-gray-700">Data Abastecimento:</label>
                                <input type="date" id="Abastecimento_Data" name="Abastecimento_Data" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                            </div>
                            <div>
                                <label for="Abastecimento_KMs" class="block text-sm font-medium text-gray-700">Km's:</label>
                                <input type="number" id="Abastecimento_KMs" name="Abastecimento_KMs" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                            </div>
                        </div>
                    </div>

                    <!-- Bloco de Equipamento (Caixas de verifica√ß√£o m√∫ltipla) -->
                    <div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">b. Equipamento (Caixas de verifica√ß√£o)</h3>
                        <div id="equipamentoCheckboxes" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                            <!-- Checkboxes geradas pelo JS para facilitar o mapeamento -->
                        </div>
                    </div>

                    <!-- Bot√£o de Submiss√£o -->
                    <div class="pt-6">
                        <button type="submit" id="submitBtn" class="w-full btn-primary bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg">
                            <span id="submitBtnText">Registar Servi√ßo</span>
                            <span id="loadingIndicator" class="hidden ml-2">
                                <!-- SVG de Loading Spin -->
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </span>
                        </button>
                    </div>

                </form>
            </div>

            <!-- 2. VISUALIZA√á√ÉO DE REGISTOS (Padr√£o: Oculto) -->
            <div id="viewContainer" class="bg-white p-6 sm:p-8 rounded-xl shadow-xl hidden">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6">Visualizar e Editar Registos</h2>

                <!-- Filtros -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 border rounded-lg bg-gray-50">
                    <div>
                        <label for="filterMotorista" class="block text-sm font-medium text-gray-700">Filtrar Motorista:</label>
                        <input type="text" id="filterMotorista" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    <div>
                        <label for="filterData" class="block text-sm font-medium text-gray-700">Filtrar Data (In√≠cio):</label>
                        <input type="date" id="filterData" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    <div class="flex items-end">
                        <button id="filterBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-4 rounded-lg shadow transition duration-200">
                            Pesquisar
                        </button>
                    </div>
                </div>

                <!-- Tabela de Registos -->
                <div class="overflow-x-auto border rounded-lg shadow">
                    <table id="recordsTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Motorista</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Matr√≠cula</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KM In√≠cio</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="recordsBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="p-4 text-center text-gray-500">Use os filtros para carregar os registos.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>

    <script>
        // *** üî¥ PASSO CR√çTICO: COLE A SUA URL AQUI E VERIFIQUE AS PERMISS√ïES ***
        // A sua URL deve come√ßar com 'https://script.google.com/macros/s/...'
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzgG0N0KwvQ5UZP8NxpeAXODIAz3gdIAudXDFtW2RU2GEB8kx89CLEDmK3dsew9x9cd/exec';
        
        let giroLinhaCount = 1;
        const EQUIPAMENTO_OPTIONS = [
            "Capacete", "√ìculos", "M√°scaras", "Macaco Descart√°vel", 
            "Caixa Primeiros Socorros", "Luvas", "Botas", 
            "Mangueira", "Acess√≥rios", "KAD"
        ];
        
        const ui = {
            girosForm: document.getElementById('girosForm'),
            girosContainer: document.getElementById('girosContainer'),
            addGiroBtn: document.getElementById('addGiroBtn'),
            submitBtn: document.getElementById('submitBtn'),
            submitBtnText: document.getElementById('submitBtnText'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            equipamentoCheckboxes: document.getElementById('equipamentoCheckboxes'),
            formContainer: document.getElementById('formContainer'),
            viewContainer: document.getElementById('viewContainer'),
            showFormBtn: document.getElementById('showFormBtn'),
            showViewBtn: document.getElementById('showViewBtn'),
            formTitle: document.getElementById('formTitle'),
            recordsTable: document.getElementById('recordsTable'),
            recordsBody: document.getElementById('recordsBody'),
            filterMotorista: document.getElementById('filterMotorista'),
            filterData: document.getElementById('filterData'),
            filterBtn: document.getElementById('filterBtn'),
            messageBox: document.getElementById('messageBox'),
            messageText: document.getElementById('messageText'),
            closeMessageBtn: document.getElementById('closeMessageBtn'),
        };

        // --- Fun√ß√µes de UI/UX ---

        /** Exibe a caixa de mensagem personalizada. */
        function showMessage(text, isError = false) {
            ui.messageText.textContent = text;
            ui.messageText.className = isError ? 'text-lg font-semibold text-red-600 mb-4' : 'text-lg font-semibold text-gray-800 mb-4';
            ui.messageBox.classList.remove('hidden');
            ui.messageBox.classList.add('flex');
        }

        /** Esconde a caixa de mensagem. */
        function hideMessage() {
            ui.messageBox.classList.add('hidden');
            ui.messageBox.classList.remove('flex');
        }

        /** Alterna o estado de loading do bot√£o de submiss√£o. */
        function setLoading(isLoading) {
            ui.submitBtn.disabled = isLoading;
            if (isLoading) {
                ui.submitBtnText.classList.add('hidden');
                ui.loadingIndicator.classList.remove('hidden');
            } else {
                ui.submitBtnText.classList.remove('hidden');
                ui.loadingIndicator.classList.add('hidden');
            }
        }
        
        /** Alterna entre a visualiza√ß√£o do Formul√°rio e da Tabela. */
        function toggleView(showForm) {
            if (showForm) {
                ui.formContainer.classList.remove('hidden');
                ui.viewContainer.classList.add('hidden');
                ui.showFormBtn.classList.replace('bg-gray-400', 'bg-blue-600');
                ui.showFormBtn.classList.replace('hover:bg-gray-500', 'hover:bg-blue-700');
                ui.showViewBtn.classList.replace('bg-blue-600', 'bg-gray-400');
                ui.showViewBtn.classList.replace('hover:bg-blue-700', 'hover:bg-gray-500');
                // Se voltar para o formul√°rio, reseta para "Novo Registo"
                clearForm();
            } else {
                ui.formContainer.classList.add('hidden');
                ui.viewContainer.classList.remove('hidden');
                ui.showFormBtn.classList.replace('bg-blue-600', 'bg-gray-400');
                ui.showFormBtn.classList.replace('hover:bg-blue-700', 'hover:bg-gray-500');
                ui.showViewBtn.classList.replace('bg-gray-400', 'bg-blue-600');
                ui.showViewBtn.classList.replace('hover:bg-gray-500', 'hover:bg-blue-700');
                loadRecords(); // Carrega os dados ao mudar para a visualiza√ß√£o
            }
        }


        // --- Fun√ß√µes de Formato de Dados ---

        /** Cria o HTML para um grupo de inputs de giro. */
        function createGiroLine(index, giroData = {}) {
            const isFirst = index === 1;
            const container = document.createElement('div');
            container.id = `giroLine-${index}`;
            container.className = 'giro-line p-4 border border-gray-200 rounded-lg bg-gray-50 grid grid-cols-2 md:grid-cols-5 gap-4 relative';
            
            // Bot√£o de remover (apenas para linhas adicionais)
            const removeButton = !isFirst ? 
                `<button type="button" data-index="${index}" class="remove-giro absolute top-1 right-1 text-red-500 hover:text-red-700 font-bold text-lg" title="Remover Giro">
                    &times;
                </button>` : 
                '';

            // ATEN√á√ÉO: Os campos NEI e Cliente n√£o s√£o mais obrigat√≥rios aqui
            container.innerHTML = `
                ${removeButton}
                <div class="col-span-2 md:col-span-1 giro-line-input">
                    <label class="block text-xs font-medium text-gray-500">NEI (Giro ${index}):</label>
                    <input type="text" data-field="NEI" value="${giroData.NEI || ''}" class="giro-input mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="col-span-2 md:col-span-1 giro-line-input">
                    <label class="block text-xs font-medium text-gray-500">Cliente (Giro ${index}):</label>
                    <input type="text" data-field="Cliente" value="${giroData.Cliente || ''}" class="giro-input mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="col-span-1 giro-line-input">
                    <label class="block text-xs font-medium text-gray-500">KM Chegada:</label>
                    <input type="number" data-field="KM_Chegada" value="${giroData.KM_Chegada || ''}" class="giro-input mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="col-span-1 giro-line-input">
                    <label class="block text-xs font-medium text-gray-500">Hora Chegada:</label>
                    <input type="time" data-field="Hora_Chegada" value="${giroData.Hora_Chegada || ''}" class="giro-input mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="col-span-1 giro-line-input">
                    <label class="block text-xs font-medium text-gray-500">Hora Sa√≠da:</label>
                    <input type="time" data-field="Hora_Saida" value="${giroData.Hora_Saida || ''}" class="giro-input mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                </div>
            `;

            // Adicionar listener para remover o giro
            if (!isFirst) {
                container.querySelector('.remove-giro').addEventListener('click', (e) => {
                    e.target.closest('.giro-line').remove();
                });
            }

            return container;
        }

        /** Gera os checkboxes de equipamento. */
        function renderEquipamentoCheckboxes() {
            ui.equipamentoCheckboxes.innerHTML = EQUIPAMENTO_OPTIONS.map(option => `
                <div class="flex items-center">
                    <input id="equipamento-${option.replace(/\s/g, '_')}" type="checkbox" name="Equipamento" value="${option}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="equipamento-${option.replace(/\s/g, '_')}" class="ml-2 block text-sm text-gray-700">
                        ${option}
                    </label>
                </div>
            `).join('');
        }

        /** Limpa o formul√°rio e reseta o estado. */
        function clearForm() {
            ui.girosForm.reset();
            document.getElementById('ID_Registo').value = '';
            
            // Limpa e reseta as linhas de giro
            ui.girosContainer.innerHTML = '';
            giroLinhaCount = 1;
            ui.girosContainer.appendChild(createGiroLine(1));

            // Atualiza o t√≠tulo e bot√£o
            ui.formTitle.textContent = 'Novo Registo de Servi√ßo';
            ui.submitBtnText.textContent = 'Registar Servi√ßo';
        }

        // --- Fun√ß√µes de Comunica√ß√£o com Apps Script ---

        /** Envia o registo para o Sheets (Adicionar ou Editar). */
        async function submitForm(event) {
            event.preventDefault();
            setLoading(true);

            const isEdit = !!document.getElementById('ID_Registo').value;
            const action = isEdit ? 'edit' : 'add';

            // 1. Coletar dados da se√ß√£o principal
            const formData = {
                action: action,
                ID_Registo: document.getElementById('ID_Registo').value,
                Data: document.getElementById('Data').value,
                KM_Inicio_Dia: document.getElementById('KM_Inicio_Dia').value,
                Hora_Inicio: document.getElementById('Hora_Inicio').value,
                KM_Saida_Dia: document.getElementById('KM_Saida_Dia').value,
                Hora_Fim: document.getElementById('Hora_Fim').value,
                Matricula: document.getElementById('Matricula').value.toUpperCase(),
                Reboque: document.getElementById('Reboque').value.toUpperCase(),
                Motorista: document.getElementById('Motorista').value,
                Hora_Descarga: document.getElementById('Hora_Descarga').value,
                KM_Descarga: document.getElementById('KM_Descarga').value,
                Servico_Status: document.getElementById('Servico_Status').value,
                Abastecimento_Data: document.getElementById('Abastecimento_Data').value,
                Abastecimento_KMs: document.getElementById('Abastecimento_KMs').value,
            };

            // Valida√ß√£o m√≠nima para novos registos
            if (!isEdit && (!formData.Data || !formData.Matricula || !formData.Motorista)) {
                showMessage("A Data, Matr√≠cula e Motorista s√£o obrigat√≥rios para um novo registo.", true);
                setLoading(false);
                return;
            }


            // 2. Coletar dados de Equipamento
            const equipamentosSelecionados = Array.from(ui.equipamentoCheckboxes.querySelectorAll('input:checked'))
                .map(cb => cb.value);
            formData.Equipamento = equipamentosSelecionados.join(', ');

            // 3. Coletar dados das linhas de Giro (Formato JSON)
            const giroLines = Array.from(ui.girosContainer.querySelectorAll('.giro-line')).map(line => {
                const giro = {};
                line.querySelectorAll('.giro-input').forEach(input => {
                    // Trata vazios como string vazia, n√£o null
                    giro[input.dataset.field] = input.value || ''; 
                });
                return giro;
            });
            formData.Giro_Linhas = JSON.stringify(giroLines); // O GAS espera um JSON string
            
            // --- DIAGN√ìSTICO DE ERROS ---
            console.log("üõ†Ô∏è URL de Destino:", GOOGLE_APPS_SCRIPT_URL);
            console.log("üõ†Ô∏è Payload Enviado:", JSON.stringify(formData));
            // ---------------------------

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors', // Crucial para requisi√ß√µes de sites externos
                    cache: 'no-cache',
                    redirect: 'follow', // üî¥ CORRE√á√ÉO: Adiciona a diretiva para seguir redirecionamentos, comum em Apps Script
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                // Se houver um erro de rede/servidor, o 'response.ok' ser√° falso.
                if (!response.ok) {
                    console.error("üî¥ ERRO HTTP:", response.status, response.statusText);
                    // Tenta obter o texto da resposta para diagn√≥stico adicional
                    const errorText = await response.text();
                    console.error("üî¥ Corpo da Resposta de Erro:", errorText);
                    throw new Error(`Erro HTTP ${response.status}. Verifique o console do navegador e as permiss√µes do Apps Script. Resposta: ${errorText.substring(0, 100)}...`);
                }

                const result = await response.json();

                if (result.success) {
                    showMessage(`Sucesso! Registo ${isEdit ? 'editado' : 'adicionado'} com ID: ${result.ID_Registo || formData.ID_Registo}`);
                    clearForm();
                    // Opcional: Mudar para a visualiza√ß√£o ap√≥s a submiss√£o
                    toggleView(false);
                } else {
                    console.error("üî¥ ERRO DE L√ìGICA DO GAS:", result.error);
                    throw new Error(result.error || 'Erro desconhecido ao processar o registo. Verifique a consola do Apps Script.');
                }

            } catch (error) {
                // Captura "Failed to fetch" (erro de rede/CORS) ou erros lan√ßados acima
                console.error("‚ùå FALHA GERAL NA SUBMISS√ÉO:", error);
                showMessage(`Falha ao registar: ${error.message}. Verifique o URL do Apps Script e as permiss√µes de implementa√ß√£o (Deploy).`, true);
            } finally {
                setLoading(false);
            }
        }

        /** Adiciona uma nova linha de inputs para um giro adicional. */
        function addGiroLine() {
            giroLinhaCount++;
            ui.girosContainer.appendChild(createGiroLine(giroLinhaCount));
            // Foca o primeiro campo da nova linha
            document.querySelector(`#giroLine-${giroLinhaCount} input[data-field="NEI"]`).focus();
        }
        
        /** Carrega todos os registos filtrados e renderiza a tabela. */
        async function loadRecords() {
            const motorista = ui.filterMotorista.value.trim();
            const data = ui.filterData.value;
            
            // Limpa a tabela
            ui.recordsBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">A carregar...</td></tr>';

            const url = new URL(GOOGLE_APPS_SCRIPT_URL);
            url.searchParams.append('action', 'get');
            if (motorista) url.searchParams.append('motorista', motorista);
            if (data) url.searchParams.append('data', data);

            try {
                const response = await fetch(url.toString(), { 
                    method: 'GET', 
                    mode: 'cors',
                    redirect: 'follow' // Adicionado para GETs
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("üî¥ ERRO HTTP no GET:", response.status, errorText);
                    throw new Error(`Erro HTTP ${response.status}: Verifique o Apps Script. Resposta: ${errorText.substring(0, 100)}...`);
                }

                const result = await response.json();
                
                if (result.success && result.records) {
                    renderRecordsTable(result.records);
                } else {
                    console.error("üî¥ ERRO DE L√ìGICA DO GAS (GET):", result.error);
                    throw new Error(result.error || 'Erro ao carregar os dados.');
                }
            } catch (error) {
                console.error("‚ùå FALHA GERAL AO CARREGAR REGISTOS:", error);
                ui.recordsBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Erro: ${error.message}</td></tr>`;
            }
        }

        /** Renderiza as linhas na tabela de visualiza√ß√£o. */
        function renderRecordsTable(records) {
            if (records.length === 0) {
                ui.recordsBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Nenhum registo encontrado com os filtros atuais.</td></tr>';
                return;
            }

            ui.recordsBody.innerHTML = records.map(record => {
                const statusClass = record.Servico_Status === 'OK' ? 'status-ok' : (record.Servico_Status === 'NOK' ? 'status-nok' : 'bg-gray-200');
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.Data}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.Motorista}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.Matricula}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.KM_Inicio_Dia}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${record.Servico_Status || 'Pendente'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button data-id="${record.ID_Registo}" class="edit-btn text-indigo-600 hover:text-indigo-900 font-semibold" title="Editar Registo">Editar</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Adicionar listeners aos bot√µes de edi√ß√£o
            ui.recordsBody.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => loadRecordForEdit(e.target.dataset.id));
            });
        }

        /** Carrega um √∫nico registo para pr√©-preencher o formul√°rio. */
        async function loadRecordForEdit(id) {
            const url = new URL(GOOGLE_APPS_SCRIPT_URL);
            url.searchParams.append('action', 'getById');
            url.searchParams.append('id', id);

            try {
                const response = await fetch(url.toString(), { 
                    method: 'GET', 
                    mode: 'cors',
                    redirect: 'follow' // Adicionado para GETs
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("üî¥ ERRO HTTP no GET by ID:", response.status, errorText);
                    throw new Error(`Erro HTTP ${response.status}: Verifique o Apps Script. Resposta: ${errorText.substring(0, 100)}...`);
                }

                const result = await response.json();

                if (result.success && result.record) {
                    fillForm(result.record);
                    toggleView(true); // Mudar para o formul√°rio
                    window.scrollTo(0, 0); // Rola para o topo
                } else {
                    console.error("üî¥ ERRO DE L√ìGICA DO GAS (GET by ID):", result.error);
                    throw new Error(result.error || 'Registo n√£o encontrado.');
                }
            } catch (error) {
                console.error("‚ùå FALHA GERAL AO CARREGAR REGISTO PARA EDI√á√ÉO:", error);
                showMessage(`Erro ao carregar: ${error.message}`, true);
            }
        }

        /** Preenche o formul√°rio com os dados do registo. */
        function fillForm(record) {
            // 1. Campos principais
            document.getElementById('ID_Registo').value = record.ID_Registo;
            document.getElementById('Data').value = record.Data;
            document.getElementById('KM_Inicio_Dia').value = record.KM_Inicio_Dia;
            document.getElementById('Hora_Inicio').value = record.Hora_Inicio;
            document.getElementById('KM_Saida_Dia').value = record.KM_Saida_Dia;
            document.getElementById('Hora_Fim').value = record.Hora_Fim;
            document.getElementById('Matricula').value = record.Matricula;
            document.getElementById('Reboque').value = record.Reboque;
            document.getElementById('Motorista').value = record.Motorista;
            document.getElementById('Hora_Descarga').value = record.Hora_Descarga;
            document.getElementById('KM_Descarga').value = record.KM_Descarga;
            document.getElementById('Servico_Status').value = record.Servico_Status;
            document.getElementById('Abastecimento_Data').value = record.Abastecimento_Data;
            document.getElementById('Abastecimento_KMs').value = record.Abastecimento_KMs;

            // 2. Equipamento (Limpa todos e marca os que est√£o no registo)
            ui.equipamentoCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            const selectedEquip = (record.Equipamento || "").split(',').map(s => s.trim());
            selectedEquip.forEach(item => {
                const checkbox = document.querySelector(`input[value="${item}"]`);
                if (checkbox) checkbox.checked = true;
            });

            // 3. Linhas de Giro (Limpa e regenera)
            ui.girosContainer.innerHTML = '';
            giroLinhaCount = 0;
            if (record.Giro_Linhas_Parsed && record.Giro_Linhas_Parsed.length > 0) {
                record.Giro_Linhas_Parsed.forEach((giro, index) => {
                    giroLinhaCount++;
                    // O campo KM_Chegada e outros s√£o strings no record, garantimos que o createGiroLine lida com isso.
                    ui.girosContainer.appendChild(createGiroLine(giroLinhaCount, {
                        NEI: giro.NEI,
                        Cliente: giro.Cliente,
                        KM_Chegada: giro.KM_Chegada,
                        Hora_Chegada: giro.Hora_Chegada,
                        Hora_Saida: giro.Hora_Saida
                    }));
                });
            } else {
                // Deve haver sempre pelo menos 1 linha
                giroLinhaCount = 1;
                ui.girosContainer.appendChild(createGiroLine(1));
            }


            // 4. Atualiza o t√≠tulo e bot√£o
            ui.formTitle.textContent = `Editar Registo: ${record.ID_Registo}`;
            ui.submitBtnText.textContent = 'Guardar Edi√ß√£o';
        }

        // --- Event Listeners e Inicializa√ß√£o ---

        document.addEventListener('DOMContentLoaded', () => {
            renderEquipamentoCheckboxes(); // Cria os checkboxes de equipamento
            clearForm(); // Inicializa o formul√°rio com 1 linha de giro
            
            ui.girosForm.addEventListener('submit', submitForm);
            ui.addGiroBtn.addEventListener('click', addGiroLine);
            ui.closeMessageBtn.addEventListener('click', hideMessage);
            ui.showFormBtn.addEventListener('click', () => toggleView(true));
            ui.showViewBtn.addEventListener('click', () => toggleView(false));
            ui.filterBtn.addEventListener('click', loadRecords);
            
            // Permite carregar registos tamb√©m ao pressionar Enter nos campos de filtro
            ui.filterMotorista.addEventListener('keyup', (e) => { if (e.key === 'Enter') loadRecords(); });
            ui.filterData.addEventListener('change', loadRecords); // Carrega ao selecionar a data
        });

    </script>
</body>
</html>
